{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://compass.schema.json",
  "title": "Compass Framework Definition",
  "description": "Schema for defining framework patterns used in architecture analysis",
  "type": "object",
  "required": ["name", "languages"],
  "properties": {
    "name": {
      "type": "string",
      "title": "Framework Name",
      "description": "The human-readable name of the framework",
      "examples": ["Spring Boot", "Django", "Express.js"]
    },
    "extends": {
      "type": "string",
      "title": "Base Framework",
      "description": "The base language or framework this extends",
      "examples": ["java", "python", "javascript"]
    },
    "languages": {
      "type": "array",
      "title": "Supported Languages",
      "description": "Programming languages supported by this framework",
      "items": {
        "type": "string",
        "examples": ["java", "kotlin", "scala"]
      },
      "minItems": 1
    },
    "repository": {
      "type": "object",
      "title": "Repository Information",
      "description": "Source repository metadata for the framework (extracted during framework generation)",
      "properties": {
        "url": {
          "type": "string",
          "title": "Repository URL",
          "description": "The HTTPS URL of the source repository",
          "examples": ["https://github.com/spring-projects/spring-framework"]
        },
        "branch": {
          "type": "string",
          "title": "Branch Name",
          "description": "The Git branch analyzed",
          "examples": ["main", "master", "develop"]
        },
        "commit": {
          "type": "string",
          "title": "Commit Hash",
          "description": "The Git commit hash analyzed",
          "examples": ["abc123def456789..."]
        },
        "tag": {
          "type": "string",
          "title": "Git Tag",
          "description": "The Git tag if the commit is tagged",
          "examples": ["v5.3.20", "1.0.0"]
        },
        "date": {
          "type": "string",
          "title": "Commit Date",
          "description": "The date of the commit in YYYY-MM-DD format",
          "examples": ["2023-05-15"]
        }
      }
    },
    "detection": {
      "type": "object",
      "title": "Framework Detection",
      "description": "Patterns used to detect if this framework is present in a codebase. Detection runs in priority order: binaries > files > dependencies > imports > annotations > code_patterns",
      "properties": {
        "binaries": {
          "title": "Binary Files",
          "description": "Compiled files or JARs that indicate framework presence (highest priority)",
          "$ref": "#/definitions/patternGroup"
        },
        "files": {
          "title": "Configuration Files",
          "description": "Framework-specific configuration or marker files",
          "$ref": "#/definitions/patternGroup"
        },
        "dependencies": {
          "type": "object",
          "title": "Package Dependencies",
          "description": "Dependencies in package manager files (pom.xml, build.gradle, package.json, etc.)",
          "additionalProperties": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/fileContentPattern"
            }
          }
        },
        "imports": {
          "title": "Import Statements",
          "description": "Package or module import statements in source code",
          "$ref": "#/definitions/patternGroup"
        },
        "annotations": {
          "title": "Framework Annotations",
          "description": "Framework-specific annotations or decorators",
          "$ref": "#/definitions/patternGroup"
        },
        "code_patterns": {
          "title": "Code Patterns",
          "description": "Class naming patterns or code conventions (lowest priority)",
          "$ref": "#/definitions/patternGroup"
        },
        "package_hierarchy": {
          "type": "object",
          "title": "Package Hierarchy",
          "description": "Package structure at multiple depth levels (extracted during framework generation)",
          "properties": {
            "type": {
              "type": "string",
              "const": "analysis",
              "description": "Always 'analysis' for package hierarchy"
            },
            "description": {
              "type": "string",
              "description": "Description of the package hierarchy data"
            },
            "levels": {
              "type": "object",
              "title": "Depth Levels",
              "description": "Packages organized by depth level (depth_2, depth_3, depth_4)",
              "properties": {
                "depth_2": {
                  "type": "array",
                  "title": "Depth 2 Packages",
                  "description": "Top-level packages (e.g., org.springframework, com.google)",
                  "items": {
                    "type": "string"
                  }
                },
                "depth_3": {
                  "type": "array",
                  "title": "Depth 3 Packages",
                  "description": "Second-level packages (e.g., org.springframework.web, com.google.cloud)",
                  "items": {
                    "type": "string"
                  }
                },
                "depth_4": {
                  "type": "array",
                  "title": "Depth 4 Packages",
                  "description": "Third-level packages (e.g., org.springframework.web.bind)",
                  "items": {
                    "type": "string"
                  }
                }
              }
            }
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "title": "Project Metadata",
      "description": "Patterns for extracting project information like name, version, contacts, repository URL, etc.",
      "properties": {
        "project_name": {
          "title": "Project Name",
          "description": "Pattern to extract the project name from files",
          "$ref": "#/definitions/fileContentPattern"
        },
        "project_version": {
          "title": "Project Version",
          "description": "Pattern to extract the project version from files",
          "$ref": "#/definitions/fileContentPattern"
        },
        "contacts": {
          "title": "Project Contacts",
          "description": "Pattern to extract contact information (emails, maintainers)",
          "$ref": "#/definitions/fileContentPattern"
        },
        "repo_url": {
          "title": "Repository URL",
          "description": "Pattern to extract the source repository URL",
          "$ref": "#/definitions/fileContentPattern"
        },
        "license": {
          "title": "License Information",
          "description": "Pattern to extract license information",
          "$ref": "#/definitions/fileContentPattern"
        },
        "organization": {
          "title": "Organization",
          "description": "Pattern to extract organization or company name",
          "$ref": "#/definitions/fileContentPattern"
        }
      },
      "additionalProperties": {
        "$ref": "#/definitions/fileContentPattern"
      }
    },
    "architecture": {
      "type": "object",
      "title": "Architecture Analysis",
      "description": "Patterns for analyzing code architecture. Categories describe what the code does (not which technology). DEPRECATED categories: 'danger' (use 'execution'), 'defense' (use 'security'), 'operations' (use 'execution' or 'presentation').",
      "properties": {
        "routing": {
          "type": "object",
          "title": "HTTP Routing",
          "description": "HTTP routing layer - maps URL patterns to code entry points",
          "properties": {
            "handler_classes": {
              "type": "object",
              "title": "Handler Classes",
              "description": "Classes that contain route handlers (Controllers, Resources, Handlers)",
              "additionalProperties": {
                "$ref": "#/definitions/patternGroup"
              }
            },
            "route_definitions": {
              "type": "object",
              "title": "Route Definitions",
              "description": "Annotations or patterns that define URL routes",
              "additionalProperties": {
                "$ref": "#/definitions/patternGroup"
              }
            },
            "parameters": {
              "type": "object",
              "title": "Parameter Bindings",
              "description": "Annotations for binding request data to method parameters",
              "additionalProperties": {
                "$ref": "#/definitions/patternGroup"
              }
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "database": {
          "type": "object",
          "title": "Database Operations",
          "description": "Data persistence and database operations",
          "properties": {
            "sql_queries": {
              "title": "SQL Queries",
              "description": "Raw SQL execution methods",
              "$ref": "#/definitions/patternGroup"
            },
            "orm_operations": {
              "title": "ORM Operations",
              "description": "ORM methods (find, save, delete, merge)",
              "$ref": "#/definitions/patternGroup"
            },
            "jpa_operations": {
              "title": "JPA Operations",
              "description": "JPA-specific operations",
              "$ref": "#/definitions/patternGroup"
            },
            "repository_pattern": {
              "title": "Repository Pattern",
              "description": "Repository/DAO pattern methods",
              "$ref": "#/definitions/patternGroup"
            },
            "nosql_operations": {
              "title": "NoSQL Operations",
              "description": "NoSQL database operations (MongoDB, Redis, etc.)",
              "$ref": "#/definitions/patternGroup"
            },
            "ldap_queries": {
              "title": "LDAP Queries",
              "description": "LDAP query operations",
              "$ref": "#/definitions/patternGroup"
            },
            "xpath_queries": {
              "title": "XPath Queries",
              "description": "XPath query execution",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "execution": {
          "type": "object",
          "title": "Code and Command Execution",
          "description": "Operations that execute code or commands (REPLACES 'danger' category)",
          "properties": {
            "native": {
              "title": "Native Command Execution",
              "description": "Process/command execution (was: danger.process)",
              "$ref": "#/definitions/patternGroup"
            },
            "expression": {
              "title": "Expression Evaluation",
              "description": "Expression language evaluation - SpEL, OGNL, JEXL (was: operations.expression_parsing)",
              "$ref": "#/definitions/patternGroup"
            },
            "reflection": {
              "title": "Reflection",
              "description": "Dynamic method invocation via reflection (was: danger.reflection)",
              "$ref": "#/definitions/patternGroup"
            },
            "deserialization": {
              "title": "Deserialization",
              "description": "Object deserialization operations (was: danger.deserialization)",
              "$ref": "#/definitions/patternGroup"
            },
            "script": {
              "title": "Script Execution",
              "description": "Script execution (JavaScript, Python, Groovy, etc.)",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "communication": {
          "type": "object",
          "title": "Network Communication",
          "description": "Network and inter-process communication",
          "properties": {
            "http": {
              "title": "HTTP Client",
              "description": "HTTP client requests",
              "$ref": "#/definitions/patternGroup"
            },
            "socket": {
              "title": "Socket Communication",
              "description": "Raw socket operations",
              "$ref": "#/definitions/patternGroup"
            },
            "rest": {
              "title": "REST API Calls",
              "description": "REST client operations",
              "$ref": "#/definitions/patternGroup"
            },
            "messaging": {
              "title": "Messaging",
              "description": "Message queues and pub/sub operations",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "data_flow": {
          "type": "object",
          "title": "Data Flow and Transformation",
          "description": "Data sources and transformation operations",
          "properties": {
            "sources": {
              "title": "Input Sources",
              "description": "Methods that receive external input (HTTP params, headers, cookies, files)",
              "$ref": "#/definitions/patternGroup"
            },
            "serialization": {
              "title": "Serialization",
              "description": "Serialization and deserialization operations",
              "$ref": "#/definitions/patternGroup"
            },
            "xml_parsing": {
              "title": "XML Parsing",
              "description": "XML parsing operations",
              "$ref": "#/definitions/patternGroup"
            },
            "propagators": {
              "title": "Data Propagators",
              "description": "Methods that transform data while preserving taint (was: operations.propagators)",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "security": {
          "type": "object",
          "title": "Security Controls",
          "description": "Security controls and protective measures (REPLACES 'defense' category)",
          "properties": {
            "authentication": {
              "title": "Authentication",
              "description": "Authentication methods (was: defense.authentication)",
              "$ref": "#/definitions/patternGroup"
            },
            "authorization": {
              "title": "Authorization",
              "description": "Access control and permission checking (was: defense.authorization)",
              "$ref": "#/definitions/patternGroup"
            },
            "cryptography": {
              "title": "Cryptography",
              "description": "Encryption, hashing, signing operations (was: defense.cryptography)",
              "$ref": "#/definitions/patternGroup"
            },
            "input_validation": {
              "title": "Input Validation",
              "description": "Input validation methods",
              "$ref": "#/definitions/patternGroup"
            },
            "sanitization": {
              "title": "Sanitization",
              "description": "Input sanitization and encoding (was: defense.sanitizer)",
              "$ref": "#/definitions/patternGroup"
            },
            "output_encoding": {
              "title": "Output Encoding",
              "description": "Output encoding and escaping",
              "$ref": "#/definitions/patternGroup"
            },
            "cookie_security": {
              "title": "Cookie Security",
              "description": "Secure cookie handling",
              "$ref": "#/definitions/patternGroup"
            },
            "logging": {
              "title": "Security Logging",
              "description": "Security-related logging (was: defense.logging)",
              "$ref": "#/definitions/patternGroup"
            },
            "secrets": {
              "title": "Secrets Management",
              "description": "Secrets handling - credential storage, API key management, password hashing, secrets managers",
              "$ref": "#/definitions/patternGroup"
            },
            "privacy": {
              "title": "Privacy Controls",
              "description": "Privacy and PII/PHI handling - data anonymization, PII protection, consent management",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "presentation": {
          "type": "object",
          "title": "Response Generation and Rendering",
          "description": "HTTP response generation and output rendering",
          "properties": {
            "template_rendering": {
              "title": "Template Rendering",
              "description": "Template engine operations (was: operations.template_rendering)",
              "$ref": "#/definitions/patternGroup"
            },
            "response_output": {
              "title": "Response Output",
              "description": "HTTP response writing methods",
              "$ref": "#/definitions/patternGroup"
            },
            "redirects": {
              "title": "HTTP Redirects",
              "description": "HTTP redirect operations",
              "$ref": "#/definitions/patternGroup"
            },
            "cookies": {
              "title": "Cookie Manipulation",
              "description": "Cookie setting and reading",
              "$ref": "#/definitions/patternGroup"
            },
            "headers": {
              "title": "Header Manipulation",
              "description": "HTTP header manipulation",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "integration": {
          "type": "object",
          "title": "External System Integration",
          "description": "Integration with external systems and services",
          "properties": {
            "filesystem": {
              "title": "Filesystem Operations",
              "description": "File I/O operations (was: danger.filesystem)",
              "$ref": "#/definitions/patternGroup"
            },
            "email": {
              "title": "Email",
              "description": "Email sending operations",
              "$ref": "#/definitions/patternGroup"
            },
            "http_clients": {
              "title": "HTTP Clients",
              "description": "HTTP client library usage",
              "$ref": "#/definitions/patternGroup"
            },
            "external_services": {
              "title": "External Services",
              "description": "Third-party service integrations",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        },
        "ai": {
          "type": "object",
          "title": "AI and LLM Operations",
          "description": "Artificial intelligence and large language model operations",
          "properties": {
            "chat": {
              "title": "Chat Completions",
              "description": "Chat completion APIs (conversational AI)",
              "$ref": "#/definitions/patternGroup"
            },
            "completion": {
              "title": "Text Completion",
              "description": "Text completion APIs (single-shot generation)",
              "$ref": "#/definitions/patternGroup"
            },
            "embedding": {
              "title": "Embeddings",
              "description": "Vector embedding generation (semantic search)",
              "$ref": "#/definitions/patternGroup"
            },
            "image": {
              "title": "Image Generation",
              "description": "Image generation and manipulation (DALL-E, Stable Diffusion)",
              "$ref": "#/definitions/patternGroup"
            },
            "audio": {
              "title": "Audio Processing",
              "description": "Audio transcription and generation (Whisper, TTS)",
              "$ref": "#/definitions/patternGroup"
            },
            "vision": {
              "title": "Vision",
              "description": "Image analysis and understanding",
              "$ref": "#/definitions/patternGroup"
            },
            "function_calling": {
              "title": "Function Calling",
              "description": "Tool and function calling capabilities",
              "$ref": "#/definitions/patternGroup"
            },
            "streaming": {
              "title": "Streaming",
              "description": "Streaming response handling",
              "$ref": "#/definitions/patternGroup"
            },
            "agents": {
              "title": "Agent Orchestration",
              "description": "AI agent orchestration (LangChain, AutoGPT, ReAct)",
              "$ref": "#/definitions/patternGroup"
            },
            "fine_tuning": {
              "title": "Fine-tuning",
              "description": "Model training and fine-tuning operations",
              "$ref": "#/definitions/patternGroup"
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/patternGroup"
          }
        }
      },
      "additionalProperties": {
        "type": "object",
        "description": "Custom architecture category (allows framework-specific extensions)",
        "additionalProperties": {
          "$ref": "#/definitions/patternGroup"
        }
      }
    }
  },
  "definitions": {
    "patternGroup": {
      "type": "object",
      "title": "Pattern Group",
      "description": "A group of patterns with the same search type",
      "required": ["target"],
      "properties": {
        "target": {
          "type": "string",
          "title": "Search Target",
          "description": "What to search (the target of the search)",
          "enum": ["filename", "filecontent", "joern"],
          "meta:enum": {
            "filename": "Search for files by name pattern",
            "filecontent": "Search within file contents",
            "joern": "Use Joern code property graph analysis"
          }
        },
        "type": {
          "type": "string",
          "title": "Pattern Type (deprecated)",
          "description": "Deprecated: Use 'target' instead. The type of search to perform",
          "enum": ["filename", "filecontent", "joern"]
        },
        "search_type": {
          "type": "string",
          "title": "Search Type",
          "description": "The specific search method to use",
          "enum": [
            "method_signature",
            "method_name_regex",
            "class_name_regex",
            "annotation_name",
            "annotation_name_regex",
            "import",
            "regex",
            "xml_element",
            "xpath",
            "yaml_path",
            "json_value"
          ],
          "meta:enum": {
            "method_signature": "Search for exact method signatures (use with target: joern)",
            "method_name_regex": "Search for method names matching regex (use with target: joern)",
            "class_name_regex": "Search for class names matching regex (use with target: joern)",
            "annotation_name": "Search for exact annotation names (use with target: joern)",
            "annotation_name_regex": "Search for annotation names matching regex (use with target: joern)",
            "import": "Search for import statements (use with target: joern)",
            "regex": "Search file contents with regex (use with target: filecontent)",
            "xml_element": "Search for XML elements (use with target: filecontent)",
            "xpath": "Search with XPath query (use with target: filecontent)",
            "yaml_path": "Search with YAML path (use with target: filecontent)",
            "json_value": "Search with JSON path (use with target: filecontent)"
          }
        },
        "pattern": {
          "title": "Pattern",
          "description": "A single pattern or array of patterns (annotation names, class names, etc.)",
          "oneOf": [
            {
              "type": "string",
              "description": "Single pattern string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Array of pattern strings (e.g., ['PreAuthorize', 'Secured', 'PostAuthorize'])"
            }
          ]
        },
        "patterns": {
          "title": "Patterns (deprecated)",
          "description": "Deprecated: Use 'pattern' instead. Multiple patterns of the same type",
          "oneOf": [
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Array of patterns"
            },
            {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              },
              "description": "Named patterns (for categorized patterns like HTTP methods)"
            }
          ]
        },
        "description": {
          "type": "string",
          "title": "Description",
          "description": "Human-readable description of what this pattern detects"
        },
        "signature": {
          "title": "Method Signature",
          "description": "A single method signature or array of signatures",
          "oneOf": [
            {
              "type": "string",
              "description": "Single signature string in format: package.class.method:returnType(paramType1,paramType2)",
              "examples": [
                "java.lang.Runtime.exec:java.lang.Process(java.lang.String)"
              ]
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Array of signature strings"
            }
          ]
        },
        "signatures": {
          "type": "array",
          "title": "Method Signatures (deprecated)",
          "description": "Deprecated: Use 'signature' instead. Array of method signatures (strings or objects with signature and description)",
          "items": {
            "oneOf": [
              {
                "type": "string",
                "description": "Simple signature string in format: package.class.method:returnType(paramType1,paramType2)",
                "examples": [
                  "java.lang.Runtime.exec:java.lang.Process(java.lang.String)",
                  "javax.servlet.http.HttpServletRequest.getParameter:java.lang.String(java.lang.String)"
                ]
              },
              {
                "type": "object",
                "description": "Signature object with description (generated by framework_generator)",
                "required": ["signature", "description"],
                "properties": {
                  "signature": {
                    "type": "string",
                    "description": "Method signature in format: package.class.method:returnType(paramType1,paramType2)",
                    "examples": [
                      "org.apache.commons.exec.DefaultExecutor.execute:int(org.apache.commons.exec.CommandLine)"
                    ]
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable description of what the method does",
                    "examples": [
                      "Executes a native system command and returns the exit code"
                    ]
                  }
                }
              }
            ]
          }
        }
      }
    },
    "namedPatternGroup": {
      "type": "object",
      "title": "Named Pattern Group",
      "description": "A pattern group with named sub-patterns",
      "required": ["target", "search_type", "patterns"],
      "properties": {
        "target": {
          "$ref": "#/definitions/patternGroup/properties/target"
        },
        "type": {
          "$ref": "#/definitions/patternGroup/properties/type"
        },
        "search_type": {
          "$ref": "#/definitions/patternGroup/properties/search_type"
        },
        "patterns": {
          "type": "object",
          "title": "Named Patterns",
          "description": "Patterns organized by name (e.g., http methods: get, post, put, delete)",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "fileContentPattern": {
      "type": "object",
      "title": "File Content Pattern",
      "description": "Pattern for searching within file contents",
      "required": ["target", "search_type"],
      "properties": {
        "target": {
          "type": "string",
          "const": "filecontent",
          "description": "Always 'filecontent' for file content searches"
        },
        "type": {
          "type": "string",
          "const": "filecontent",
          "description": "Deprecated: Use 'target' instead. Always 'filecontent' for file content searches"
        },
        "search_type": {
          "type": "string",
          "enum": ["regex", "xml_element", "xpath", "yaml_path", "json_value"],
          "description": "The type of file content search"
        },
        "files": {
          "type": "array",
          "title": "Files to Search",
          "description": "List of files to search within",
          "items": {
            "type": "string"
          }
        },
        "pattern": {
          "type": "string",
          "title": "Search Pattern",
          "description": "The pattern to search for (regex, element name, path, etc.)"
        },
        "query": {
          "type": "string",
          "title": "Query",
          "description": "XPath query (for search_type: xpath)"
        },
        "path": {
          "type": "string",
          "title": "Path",
          "description": "YAML or JSON path (for search_type: yaml_path or json_value)"
        },
        "value": {
          "type": "string",
          "title": "Expected Value",
          "description": "Expected value for the pattern (optional)"
        },
        "group": {
          "type": "integer",
          "title": "Regex Capture Group",
          "description": "Capture group number to extract from regex match (for search_type: regex)"
        },
        "library": {
          "type": "string",
          "title": "Library Name",
          "description": "Name of the library being detected (for dependency detection)"
        }
      }
    }
  }
}
